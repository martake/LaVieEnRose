# v2.0 — 軌道微分＋随伴変数法によるパラメータ推定の比較実験

有限差分法（v1.0 の手法）と随伴変数法（解析的勾配）を、**同一の世界に2体のエージェントを同時配置**してリアルタイムに比較する実験環境。

## 概要

v1.0 の HTML デモでは、世界の構造式 `A(θ)` の未知パラメータ `θ = (θ_r, θ_s, θ_d)` を有限差分法で推定していた。本実験では**随伴変数法**を導入し、同じ系に対する推定の収束速度・精度を比較する。

```
┌──────────────────────────────────────────┐
│           1つの世界 (World)               │
│        真のダイナミクス A(θ*), 報酬場     │
│                                          │
│   🔵 Agent A (有限差分法)                 │
│   🟠 Agent B (随伴変数法)                 │
│                                          │
│   - 同じ初期位置からスタート              │
│   - 同じ報酬場を探索                      │
│   - 各自が独立にθを推定                  │
│   - 世界のノイズは共有（同一シード）       │
└──────────────────────────────────────────┘
```

両エージェントは同じ世界に存在するが互いに干渉しない。同じ初期条件・同じノイズ系列を使うことで、学習手法の違いのみが比較対象になる。

## 起動方法

### Docker（推奨）

```bash
# リポジトリルートで
docker compose up --build
```

ブラウザで http://localhost:8080 にアクセス。

### ローカル実行

```bash
cd python
pip install -r requirements.txt
python main.py
```

## ファイル構成

```
python/
  world.py              — 世界モデル（A(θ), 射影P, 報酬関数、ノイズ生成）
  agent_base.py         — エージェント基底クラス（共通インターフェース）
  agent_finite_diff.py  — 有限差分法エージェント（v1.0 JS実装の移植）
  agent_adjoint.py      — 随伴変数法エージェント（解析的勾配）
  simulation.py         — 1つの世界 + 2体のエージェントを同時に進行させるループ
  server.py             — FastAPI + WebSocket リアルタイムサーバー
  static/index.html     — ブラウザUI（Canvas描画）
  main.py               — エントリーポイント
  requirements.txt      — Python依存パッケージ
Dockerfile
docker-compose.yml
```

## 手法の比較

### 有限差分法（Agent A 🔵）

各パラメータ `θ_k` について `±ε` の摂動で予測誤差の差分から勾配を近似する。1ステップあたり 6回の追加予測（3パラメータ × 2摂動）が必要。

### 随伴変数法（Agent B 🟠）

`∂A/∂θ_k` の解析式を用いて正確な勾配を計算する。追加の予測評価は不要。

実装は2段階:
- **W < 3**: 直接感度法（1ステップ解析的勾配）
- **W ≥ 3**: ウィンドウ付き随伴法（現在のθでforward再実行 → adjoint backward）

勾配はウィンドウ幅で正規化し、クリッピングで数値安定性を確保。

## UI操作

| 操作 | 説明 |
|------|------|
| ▶ / ⏸ | 自動実行の開始・停止 |
| 1ステップ | 手動で1ステップ進める |
| リセット | 初期状態に戻す |
| 速度スライダー | ステップ間隔の調整（50ms〜1500ms） |
| ウィンドウ幅 W | 随伴法の逆伝搬ウィンドウ幅（2〜50） |

キーボードショートカット: Space（再生/停止）, S（1ステップ）, R（リセット）

## 画面構成

**左 — 観測平面（Canvas）**
- 🔵 Agent A（有限差分法）の軌跡と現在位置
- 🟠 Agent B（随伴変数法）の軌跡と現在位置
- 背景: 真の報酬場（エージェントには不可視）

**右 — 比較パネル**
- θ̂推定バー: 真値（緑）・Agent A（青）・Agent B（橙）を並べて表示
- θ誤差収束グラフ: `||θ̂ − θ*||` の推移（2本重ね描き）
- 観測予測誤差グラフ: `||e_t||` の推移
- 累積報酬グラフ
- ステップログ

## 技術スタック

- **バックエンド**: Python 3.12, FastAPI, uvicorn, WebSocket
- **フロントエンド**: HTML5 Canvas（外部依存なし）
- **実行環境**: Docker
